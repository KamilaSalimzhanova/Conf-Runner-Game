<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Conf Runner Game</title>
  <style>
    :root {
      --bg: #f0f4f8;
      --fg: #111827;
      --card: #ffffff;
      --line: #cbd5e1;
      --accent: #2563eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--fg);
      display: grid;
      place-items: center;
      min-height: 100dvh;
    }
    .wrap { width: min(920px, 100vw); padding: 10px; }
    .hud {
      display: flex; gap: 8px; align-items: center; justify-content: space-between;
      margin-bottom: 8px;
    }
    .badge {
      background: var(--card); border: 1px solid var(--line);
      padding: 8px 12px; border-radius: 12px; font-weight: 700;
    }
    .btn {
      appearance: none; border: 1px solid var(--line); background: var(--card);
      padding: 8px 12px; border-radius: 12px; cursor: pointer; font-weight: 700;
    }
    .btn:active { transform: translateY(1px); }
    canvas {
      width: 100%; height: auto;
      background: linear-gradient(#fff, #eef3f8 60%);
      border: 2px solid var(--fg); border-radius: 14px;
      touch-action: manipulation;
    }
    .hint { margin-top: 8px; opacity: .7; font-size: 14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">
      <div id="score" class="badge">–û—á–∫–∏: 0</div>
      <div style="display:flex; gap:8px;">
        <button id="startBtn" class="btn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button id="pauseBtn" class="btn">‚è∏ –ü–∞—É–∑–∞</button>
        <button id="sendBtn" class="btn">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
      </div>
    </div>
    <canvas id="game" width="900" height="380"></canvas>
    <div class="hint">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Space/‚Üë –∏–ª–∏ –¢–ê–ü/—Å–≤–∞–π–ø –≤–≤–µ—Ä—Ö ‚Äî –ø—Ä—ã–∂–æ–∫. –°–æ–±–∏—Ä–∞–π üç™ ‚òï üç© üç´ ‚Üí +1. –ë–∞–≥ üêû ‚Üí ‚àí1. –ò–≥—Ä–∞ —É—Å–∫–æ—Ä—è–µ—Ç—Å—è.</div>
  </div>

  <script>
    // ========== Telegram Mini App bootstrap ==========
    const TG = window.Telegram?.WebApp;
    if (TG) {
      try {
        TG.ready();
        TG.expand();
        const tp = TG.themeParams || {};
        if (tp.bg_color) document.body.style.background = tp.bg_color;
      } catch (e) {}
    }

    // ========== Canvas & World ==========
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const groundY = H - 36;

    // HUD
    const scoreEl = document.getElementById('score');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const sendBtn  = document.getElementById('sendBtn');

    // Runner image
    const runnerImg = new Image();
    runnerImg.src = 'assets/runner.png';

    // Game state
    const STATE = { STOP: 0, RUN: 1, PAUSE: 2 };
    let state = STATE.STOP;
    let score = 0;
    let lastTime = 0;

    // Runner (–ø–µ—Ä—Å–æ–Ω–∞–∂)
    const runner = {
      x: 90,
      y: groundY - 84,
      w: 84,
      h: 84,
      vy: 0,
      gravity: 0.95,
      jumpForce: -18,
      onGround: true,
      bobT: 0 // "–ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ" –ø—Ä–∏ –±–µ–≥–µ
    };

    // –ú–∏—Ä/—Å–ª–æ–∂–Ω–æ—Å—Ç—å
    const world = {
      speed: 6,          // –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
      accel: 0.0009,     // —É—Å–∫–æ—Ä–µ–Ω–∏–µ px/ms^2
      spawnEvery: 1000,  // –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–ø–∞–≤–Ω–∞ (–º—Å)
      minSpawn: 520,
      lastSpawn: 0,
      time: 0
    };

    // –û–±—ä–µ–∫—Ç—ã
    const goodies = ['üç™','‚òï','üç©','üç´','ü•ê','üßÉ','üéß','üç¨'];
    const items = []; // {type:'good'|'bug', x,y,w,h, emoji}

    function spawnItem() {
      const isBug = Math.random() < 0.42; // —á–∞—â–µ –±–∞–≥–∏ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
      const size = isBug ? 34 : 30;
      // –≤–∫—É—Å–Ω—è—à–∫–∏ –∏–Ω–æ–≥–¥–∞ –ø–æ–≤—ã—à–µ, —á—Ç–æ–±—ã –ø—Ä—ã–≥–∞—Ç—å –∑–∞ –Ω–∏–º–∏
      const y = isBug ? (groundY - size) : (Math.random() < 0.6 ? groundY - size - 24 : groundY - size - 110);

      items.push({
        type: isBug ? 'bug' : 'good',
        emoji: isBug ? 'üêû' : goodies[(Math.random()*goodies.length)|0],
        x: W + 20,
        y,
        w: size,
        h: size
      });
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    function jump() {
      if (state !== STATE.RUN) return;
      if (runner.onGround) {
        runner.vy = runner.jumpForce;
        runner.onGround = false;
        TG?.HapticFeedback?.impactOccurred?.('light');
      }
    }
    document.addEventListener('keydown', e => {
      if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); jump(); }
    });
    // –∂–µ—Å—Ç—ã (—Ç–∞–ø/—Å–≤–∞–π–ø –≤–≤–µ—Ä—Ö)
    let touchStartY = 0, touchStartX = 0;
    canvas.addEventListener('touchstart', (e) => {
      const t = e.changedTouches[0];
      touchStartY = t.clientY; touchStartX = t.clientX;
    }, {passive:true});
    canvas.addEventListener('touchend', (e) => {
      const t = e.changedTouches[0];
      const dy = t.clientY - touchStartY;
      const dx = t.clientX - touchStartX;
      if (Math.abs(dy) < 30 && Math.abs(dx) < 30) jump();      // —Ç–∞–ø
      else if (dy < -30 && Math.abs(dy) > Math.abs(dx)) jump(); // —Å–≤–∞–π–ø –≤–≤–µ—Ä—Ö
    }, {passive:true});

    // –ö–Ω–æ–ø–∫–∏
    startBtn.onclick = () => { if (state !== STATE.RUN) { state = STATE.RUN; lastTime = performance.now(); requestAnimationFrame(loop); } };
    pauseBtn.onclick = () => { if (state === STATE.RUN) state = STATE.PAUSE; else if (state === STATE.PAUSE) { state = STATE.RUN; lastTime = performance.now(); requestAnimationFrame(loop); } };
    sendBtn.onclick  = () => sendScore(score);

    // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è (AABB)
    function hit(ax,ay,aw,ah,bx,by,bw,bh) {
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    function update(dt) {
      world.time += dt;
      world.speed += world.accel * dt;
      if (world.spawnEvery > world.minSpawn) world.spawnEvery -= 0.006 * dt;

      // –°–ø–∞–≤–Ω
      if (world.time - world.lastSpawn > world.spawnEvery) {
        spawnItem(); world.lastSpawn = world.time;
      }

      // –§–∏–∑–∏–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      runner.y += runner.vy;
      if (!runner.onGround) runner.vy += runner.gravity;
      if (runner.y >= groundY - runner.h) {
        runner.y = groundY - runner.h; runner.vy = 0; runner.onGround = true;
      }

      // "–ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ" –ø—Ä–∏ –±–µ–≥–µ (–ø—Ä–æ—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ç–≤–∏–∫)
      runner.bobT += dt * 0.01;

      // –î–≤–∏–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ + —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
      for (let i = items.length - 1; i >= 0; i--) {
        const it = items[i];
        it.x -= world.speed;

        // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Ö–∏—Ç–±–æ–∫—Å–æ–º –∏–≥—Ä–æ–∫–∞ (–Ω–µ–º–Ω–æ–≥–æ —É–∂–µ, —á—Ç–æ–±—ã —á–µ—Å—Ç–Ω–µ–µ)
        const px = runner.x + 10, py = runner.y + 6, pw = runner.w - 20, ph = runner.h - 10;
        if (hit(px,py,pw,ph, it.x,it.y,it.w,it.h)) {
          if (it.type === 'good') { score += 1; TG?.HapticFeedback?.notificationOccurred?.('success'); }
          else { score -= 1; TG?.HapticFeedback?.notificationOccurred?.('error'); }
          items.splice(i,1);
          scoreEl.textContent = '–û—á–∫–∏: ' + score;
          continue;
        }
        // —É–¥–∞–ª—è–µ–º —É—à–µ–¥—à–∏–µ –∑–∞ —ç–∫—Ä–∞–Ω
        if (it.x < -80) items.splice(i,1);
      }
    }

    // –†–µ–Ω–¥–µ—Ä
    function draw() {
      ctx.clearRect(0,0,W,H);

      // —Ñ–æ–Ω–æ–≤—ã–µ –ø–æ–ª–æ—Å—ã
      ctx.globalAlpha = 0.06;
      for (let i=0;i<H;i+=24){ ctx.fillStyle = i%48===0 ? '#64748b' : '#334155'; ctx.fillRect(0,i,W,24); }
      ctx.globalAlpha = 1;

      // –∑–µ–º–ª—è
      ctx.strokeStyle = '#0f172a'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(W, groundY); ctx.stroke();

      // –¥–æ—Ä–æ–∂–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞
      ctx.globalAlpha = 0.15;
      for (let i=0;i<W;i+=40){ ctx.fillStyle = '#0f172a'; ctx.fillRect(i, groundY+10, 24, 4); }
      ctx.globalAlpha = 1;

      // –ø—Ä–µ–¥–º–µ—Ç—ã
      ctx.font = '28px system-ui, serif';
      for (const it of items) {
        ctx.fillText(it.emoji, it.x, it.y + it.h - 4);
        if (it.type === 'bug') {
          ctx.globalAlpha = 0.08; ctx.fillStyle = '#ef4444';
          ctx.fillRect(it.x, it.y, it.w, it.h);
          ctx.globalAlpha = 1;
        }
      }

      // –∏–≥—Ä–æ–∫ (—Å –ª—ë–≥–∫–∏–º –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ–º –ø–æ —Å–∏–Ω—É—Å—É)
      const bob = Math.sin(runner.bobT) * (runner.onGround ? 1.5 : 0);
      ctx.drawImage(runnerImg, runner.x, runner.y + bob, runner.w, runner.h);
    }

    // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
    function loop(now) {
      if (state !== STATE.RUN) return;
      const dt = Math.min(50, now - lastTime);
      lastTime = now;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ Telegram
    function sendScore(value) {
      if (!TG) { alert('Score: ' + value); return; }
      try {
        TG.HapticFeedback?.impactOccurred?.('medium');
        TG.sendData(JSON.stringify({ game: 'conf_runner', score: value, ts: Date.now() }));
        // TG.close(); // –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –≤–µ–±-–∞–ø–ø –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
      } catch (e) {}
    }

    // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
    runnerImg.onload = () => { scoreEl.textContent = '–û—á–∫–∏: ' + score; };
  </script>
</body>
</html>
